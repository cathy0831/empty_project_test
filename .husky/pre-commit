echo "âœ¨ pre-commit hook is running!"

# JavaScript æª¢æŸ¥
if ! yarn lint-staged; then
  echo "ğŸš« lint-staged failedï¼Œè«‹ä¿®æ­£å¾Œå†æäº¤ï¼"
  exit 1
fi

# å–å¾—å·² staged å’Œ unstaged çš„ Ruby æª”æ¡ˆï¼ˆæ–°å¢/ä¿®æ”¹/è¤‡è£½ï¼‰
staged_files=$(git diff --cached --name-only --diff-filter=ACM | sort)
unstaged_files=$(git diff --name-only --diff-filter=ACM | sort)

# æ‰¾å‡ºåŒæ™‚å­˜åœ¨ staged å’Œ unstaged çš„æª”æ¡ˆï¼ˆæé†’å¿˜è¨˜ git addï¼‰
echo "$staged_files" > /tmp/staged.txt
echo "$unstaged_files" > /tmp/unstaged.txt

overlap_files=$(comm -12 /tmp/staged.txt /tmp/unstaged.txt)
if [ -n "$overlap_files" ]; then
  echo "ğŸš« ä½ æœ‰ä¿®æ”¹å¾Œå¿˜è¨˜æ”¾é€²æš«å­˜å€çš„æª”æ¡ˆï¼Œè«‹å…ˆ git addï¼"
  echo "$overlap_files"
  rm /tmp/staged.txt /tmp/unstaged.txt
  exit 1
fi
rm /tmp/staged.txt /tmp/unstaged.txt

# å¦‚æœæœ‰ staged çš„ Ruby æª”æ¡ˆï¼Œè·‘ RuboCop æª¢æŸ¥
if [ -n "$staged_files" ]; then
  if ! bundle exec rubocop --force-exclusion --format simple $staged_files; then
    echo "ğŸš« RuboCop æª¢æŸ¥æœªé€šéï¼Œè«‹ä¿®æ­£ç¨‹å¼ç¢¼æ ¼å¼ï¼"
    exit 1
  fi
fi
